# On utilise une image Node.js solide
FROM node:18-bullseye

# Installation des dÃ©pendances systÃ¨me (OpenSSL requis par Prisma)
RUN apt-get update && apt-get install -y openssl python3 make g++ && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# 1. Copie des fichiers de dÃ©pendances
COPY app/package*.json ./

# 2. Installation complÃ¨te
RUN npm install

# 3. Copie du code source
COPY app/ .

# --- ðŸš‘ FIX FICHIER MANQUANT ðŸš‘ ---
# On recrÃ©e le fichier prisma-client.ts
RUN echo "import { PrismaClient } from '@prisma/client'; const prisma = new PrismaClient(); export default prisma;" > prisma/prisma-client.ts

# 4. GÃ‰NÃ‰RATION CRITIQUE (BUILD TIME)
# On gÃ©nÃ¨re les types maintenant pour qu'ils soient prÃªts avant le dÃ©marrage
RUN npx prisma generate

# 5. Exposition du port
EXPOSE 3000

# 6. DÃ‰MARRAGE SANS CACHE
# On ajoute --skip-nx-cache pour forcer NX Ã  relire les types que Prisma vient de crÃ©er
CMD sh -c "npx prisma generate && npx nx serve api --host=0.0.0.0 --skip-nx-cache"